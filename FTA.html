<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramenta de Transcri√ß√£o de √Åudios</title>
    <style>
        /* Estilos CSS (com adi√ß√£o para a nova se√ß√£o) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8f9fa; color: #343a40; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); text-align: center; width: 95%; max-width: 800px; }
        h1 { color: #1a73e8; margin-bottom: 10px; }
        .subtitle { font-size: 16px; font-weight: 500; color: #5f6368; margin-top: 0; margin-bottom: 35px; }
        p { color: #5f6368; margin-bottom: 30px; line-height: 1.6; }
        .api-key-wrapper { display: flex; align-items: center; gap: 8px; }
        #apiKeyInput { flex-grow: 1; margin-bottom: 0; }
        .paste-btn { padding: 10px 12px; font-size: 18px; background-color: #e9ecef; border: 1px solid #dee2e6; border-radius: 8px; cursor: pointer; }
        #apiKeyStatus { font-size: 20px; min-width: 25px; }
        .status-ok { color: #28a745; }
        .status-error { color: #dc3545; }
        
        /* NOVO: Estilos para a se√ß√£o "Salvar Chave" */
        .save-key-options { text-align: left; margin-top: 10px; margin-bottom: 25px; }
        .save-key-checkbox-wrapper { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .api-key-info { font-size: 12px; color: #6c757d; margin-bottom: 0; line-height: 1.5; }
        .api-key-info a { color: #1a73e8; }
        
        .button { color: white; padding: 14px 28px; border-radius: 8px; cursor: pointer; display: inline-block; font-weight: bold; transition: all 0.2s; border: none; font-size: 16px; margin: 5px; }
        .button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        /* ...demais estilos sem altera√ß√£o... */
        .button:disabled { background-color: #adb5bd; cursor: not-allowed; }
        .file-label { background-color: #1a73e8; }
        #startButton { background-color: #34a853; }
        #pauseResumeButton { background-color: #ff9800; }
        #stopButton { background-color: #d93025; }
        #downloadReportButton { background-color: #fbbc05; color: #333; }
        #liveReportContainer { margin-top: 20px; text-align: left; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px 20px; max-height: 60vh; overflow-y: auto; background-color: #fdfdfd; }
        .result-item { border-bottom: 1px solid #e9ecef; padding: 20px 5px; }
        .result-item:last-child { border-bottom: none; }
        .result-title { display: flex; align-items: center; font-weight: bold; font-size: 16px; margin-bottom: 12px; color: #343a40; }
        .locate-btn { background: none; border: none; cursor: pointer; font-size: 20px; margin-left: 10px; padding: 0 5px; }
        .locate-btn:hover { transform: scale(1.2); }
        .audio-player { width: 100%; margin-bottom: 12px; }
        .result-text { font-family: 'SF Mono', 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; line-height: 1.7; color: #212529; padding: 8px; border: 1px solid transparent; border-radius: 6px; }
        .result-text[contenteditable="true"]:focus { outline: none; border-color: #1a73e8; background-color: #f8f9fa; box-shadow: 0 0 5px rgba(26, 115, 232, 0.2); }
        .manual-entry-btn { background-color: #ffc107; color: #333; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .manual-entry-placeholder { color: #6c757d; }
        #status { margin-top: 25px; font-size: 16px; min-height: 50px; font-weight: 500; position: relative; }
        #copy-notification { position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); background-color: #28a745; color: white; padding: 5px 15px; border-radius: 15px; font-size: 12px; opacity: 0; transition: opacity 0.5s; }
        #errorLogContainer { margin-top: 20px; }
        #errorLog { min-height: 100px; color: #d93025; background-color: #fbe9e7; }
        .hidden { display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ferramenta de Transcri√ß√£o de √Åudios</h1>
        <p class="subtitle">Desenvolvido por Pedro Henrique - 2025</p>
        <p>Transcreva, ou√ßa, edite e adicione transcri√ß√µes manuais. Clique no √≠cone de pasta (üìÅ) para copiar o nome do arquivo e localiz√°-lo em seu computador.</p>
        
        <div class="api-key-wrapper">
            <input type="password" id="apiKeyInput" placeholder="Cole sua Chave de API do Google AI aqui">
            <button class="paste-btn" id="pasteApiKeyButton" title="Colar Chave da √Årea de Transfer√™ncia">&#128203;</button>
            <span id="apiKeyStatus"></span>
        </div>

        <div class="save-key-options">
            <div class="save-key-checkbox-wrapper">
                <input type="checkbox" id="saveApiKeyCheckbox">
                <label for="saveApiKeyCheckbox">Salvar chave no navegador para uso futuro.</label>
            </div>
            <p class="api-key-info">
                Voc√™ pode obter sua chave gratuitamente no <a href="https://aistudio.google.com/" target="_blank" rel="noopener noreferrer">Google AI Studio</a>.<br>
                <strong>Aviso:</strong> Se marcada, a chave ser√° salva apenas no seu navegador. N√£o a compartilhe.
            </p>
        </div>

        <div>
            <label for="fileInput" id="fileLabel" class="button file-label">Selecionar Arquivos (M√°x: 200)</label>
            <input type="file" id="fileInput" accept="audio/*" multiple class="hidden">
        </div>
        
        <div id="status">
            <p id="file-count">&nbsp;</p>
            <p id="status-message">Nenhum arquivo selecionado.</p>
            <div id="copy-notification">Nome do arquivo copiado!</div>
        </div>

        <div id="controls">
             <button id="startButton" class="button">Iniciar Transcri√ß√£o</button>
             <button id="pauseResumeButton" class="button hidden">Pausar</button>
             <button id="stopButton" class="button hidden">Parar</button>
        </div>
        <div id="loader" class="loader hidden"></div>
        <div id="resultsContainer" class="hidden">
            <div id="liveReportContainer"></div>
            <div id="errorLogContainer" class="hidden">
                <h3>Log de Erros Detalhados:</h3>
                <textarea id="errorLog" readonly></textarea>
            </div>
            <button id="downloadReportButton" class="button">Baixar Relat√≥rio Final</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        
        const MAX_FILES = 200;
        const MAX_RETRIES = 3;
        const API_KEY_LENGTH = 39;
        const PLACEHOLDER_TEXT = "Digite a transcri√ß√£o aqui...";

        // Seletores de elementos, incluindo o novo checkbox
        const apiKeyInput = document.getElementById('apiKeyInput');
        const pasteApiKeyButton = document.getElementById('pasteApiKeyButton');
        const apiKeyStatus = document.getElementById('apiKeyStatus');
        const saveApiKeyCheckbox = document.getElementById('saveApiKeyCheckbox'); // NOVO
        // ...demais seletores sem altera√ß√£o
        const fileInput = document.getElementById('fileInput');
        const fileCountP = document.getElementById('file-count');
        const statusMessageP = document.getElementById('status-message');
        const liveReportContainer = document.getElementById('liveReportContainer');
        const startButton = document.getElementById('startButton');
        const pauseResumeButton = document.getElementById('pauseResumeButton');
        const stopButton = document.getElementById('stopButton');
        const downloadReportButton = document.getElementById('downloadReportButton');
        const loader = document.getElementById('loader');
        const errorLogContainer = document.getElementById('errorLogContainer');
        const errorLog = document.getElementById('errorLog');
        const fileLabel = document.getElementById('fileLabel');
        const resultsContainer = document.getElementById('resultsContainer');
        const copyNotification = document.getElementById('copy-notification');

        let state = { files: [], apiKey: '', status: 'idle' };

        // Fun√ß√µes de UI e auxiliares (sem altera√ß√£o)
        function updateUI() { const canStart = state.files.length > 0 && !!state.apiKey && state.apiKey.length === API_KEY_LENGTH; loader.classList.add('hidden'); startButton.classList.add('hidden'); pauseResumeButton.classList.add('hidden'); stopButton.classList.add('hidden'); fileLabel.classList.remove('hidden'); startButton.disabled = !canStart; resultsContainer.classList.toggle('hidden', state.status === 'idle'); switch (state.status) { case 'idle': resultsContainer.classList.add('hidden'); startButton.classList.remove('hidden'); break; case 'stopped': case 'finished': startButton.classList.remove('hidden'); break; case 'running': fileLabel.classList.add('hidden'); pauseResumeButton.classList.remove('hidden'); pauseResumeButton.textContent = 'Pausar'; stopButton.classList.remove('hidden'); loader.classList.remove('hidden'); break; case 'paused': fileLabel.classList.add('hidden'); pauseResumeButton.classList.remove('hidden'); pauseResumeButton.textContent = 'Retomar'; stopButton.classList.remove('hidden'); break; } }
        function updateStatus(message) { statusMessageP.innerHTML = message; }
        async function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
        async function toBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = error => reject(error); }); }
        async function fileToGenerativePart(file) { const base64EncodedData = await toBase64(file); return { inlineData: { data: base64EncodedData, mimeType: file.type || 'audio/*' } }; }
        async function countdown(seconds, processed, total) { for (let i = seconds; i > 0; i--) { while (state.status === 'paused') { updateStatus(`Processo Pausado na contagem... (${processed}/${total})`); await sleep(500); } if (state.status !== 'running') return; updateStatus(`Processando... (${processed}/${total}) - Pr√≥ximo em ${i}s...`); await sleep(1000); } }
        
        // --- Event Handlers ---
        
        // L√≥gica de colar e validar a Chave de API (ATUALIZADA para interagir com o localStorage)
        apiKeyInput.addEventListener('input', () => {
            const key = apiKeyInput.value.trim();
            state.apiKey = key;
            apiKeyStatus.className = '';

            if (key.length === 0) {
                apiKeyStatus.innerHTML = '';
            } else if (key.length === API_KEY_LENGTH) {
                apiKeyStatus.innerHTML = '&#10004;';
                apiKeyStatus.className = 'status-ok';
                if (saveApiKeyCheckbox.checked) {
                    localStorage.setItem('googleApiKey', key);
                }
            } else {
                apiKeyStatus.innerHTML = '&#10006;';
                apiKeyStatus.className = 'status-error';
            }
            
            if (!saveApiKeyCheckbox.checked) {
                localStorage.removeItem('googleApiKey');
            }
            updateUI();
        });

        // NOVO: Listener para o checkbox de salvar a chave
        saveApiKeyCheckbox.addEventListener('change', () => {
            if (saveApiKeyCheckbox.checked && state.apiKey.length === API_KEY_LENGTH) {
                localStorage.setItem('googleApiKey', state.apiKey);
            } else {
                localStorage.removeItem('googleApiKey');
            }
        });

        // Demais listeners (sem altera√ß√£o da l√≥gica principal)
        pasteApiKeyButton.addEventListener('click', async () => { try { const text = await navigator.clipboard.readText(); apiKeyInput.value = text; apiKeyInput.dispatchEvent(new Event('input', { bubbles: true })); } catch (err) { console.error('Falha ao colar texto: ', err); updateStatus('N√£o foi poss√≠vel ler da √°rea de transfer√™ncia.'); } });
        liveReportContainer.addEventListener('click', (event) => { const target = event.target; if (target.classList.contains('locate-btn')) { const filename = target.dataset.filename; navigator.clipboard.writeText(filename).then(() => { copyNotification.style.opacity = '1'; setTimeout(() => { copyNotification.style.opacity = '0'; }, 2000); }).catch(err => console.error('Falha ao copiar:', err)); } if (target.classList.contains('manual-entry-btn')) { const parent = target.parentElement; parent.innerHTML = `<div class="result-text manual-entry-placeholder" contenteditable="true">${PLACEHOLDER_TEXT}</div>`; parent.querySelector('.result-text').focus(); } });
        liveReportContainer.addEventListener('play', (event) => { const currentAudio = event.target; const allPlayers = liveReportContainer.querySelectorAll('audio'); allPlayers.forEach(player => { if (player !== currentAudio) { player.pause(); } }); }, true);
        liveReportContainer.addEventListener('focusin', (event) => { const target = event.target; if(target.classList.contains('manual-entry-placeholder') && target.textContent === PLACEHOLDER_TEXT) { target.textContent = ''; target.classList.remove('manual-entry-placeholder'); } });
        liveReportContainer.addEventListener('focusout', (event) => { const target = event.target; if(target.hasAttribute('contenteditable') && target.textContent.trim() === '') { target.textContent = PLACEHOLDER_TEXT; target.classList.add('manual-entry-placeholder'); } });
        fileInput.addEventListener('change', (event) => { state.files.forEach(fileData => URL.revokeObjectURL(fileData.url)); const selectedFiles = Array.from(event.target.files); if (selectedFiles.length > MAX_FILES) { alert(`Limite excedido! Por favor, selecione no m√°ximo ${MAX_FILES} arquivos.`); fileInput.value = ""; state.files = []; } else { state.files = selectedFiles.map((file, index) => ({ file: file, url: URL.createObjectURL(file), id: `file-${index}` })); } if (state.files.length > 0) { fileCountP.textContent = `${state.files.length} arquivo(s) selecionado(s).`; updateStatus('Pronto para iniciar.'); } else { fileCountP.innerHTML = '&nbsp;'; updateStatus('Nenhum arquivo selecionado.'); } state.status = 'idle'; liveReportContainer.innerHTML = ''; updateUI(); });
        window.addEventListener('beforeunload', () => { state.files.forEach(fileData => URL.revokeObjectURL(fileData.url)); });
        pauseResumeButton.addEventListener('click', () => { if (state.status === 'running') { state.status = 'paused'; updateStatus('Processo Pausado.'); } else if (state.status === 'paused') { state.status = 'running'; updateStatus('Retomando...'); } updateUI(); });
        stopButton.addEventListener('click', () => { state.status = 'stopped'; updateStatus('Processo interrompido pelo usu√°rio.'); updateUI(); });
        downloadReportButton.addEventListener('click', () => { let fullReport = ""; const resultItems = liveReportContainer.querySelectorAll('.result-item'); resultItems.forEach(item => { const filename = item.querySelector('.result-title-text').textContent; const transcriptionDiv = item.querySelector('.result-text'); let transcription = '[TRANSCRI√á√ÉO N√ÉO DISPON√çVEL]'; if(transcriptionDiv) { transcription = transcriptionDiv.textContent; if (transcriptionDiv.classList.contains('manual-entry-placeholder') && transcription === PLACEHOLDER_TEXT) { transcription = '[TRANSCRI√á√ÉO MANUAL N√ÉO INSERIDA]'; } } fullReport += `--- IN√çCIO: ${filename} ---\n${transcription}\n--- FIM: ${filename} ---\n\n`; }); const errorLogContent = errorLog.value.trim(); const errorReport = errorLogContent ? `\n\nLOG DE ERROS\n============\n\n${errorLogContent}` : ''; const finalContent = `RELAT√ìRIO DE TRANSCRI√á√ÉO\n=========================\n\n${fullReport}${errorReport}`; const blob = new Blob([finalContent], {type: 'text/plain;charset=utf-8'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); const date = new Date().toISOString().slice(0, 10).replace(/-/g, ''); a.href = url; a.download = `RelatorioTranscricao_${date}.txt`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); });
        
        // --- Fun√ß√£o Principal de Transcri√ß√£o (sem altera√ß√£o) ---
        startButton.addEventListener('click', async () => { state.status = 'running'; updateUI(); liveReportContainer.innerHTML = ''; errorLog.value = ''; errorLogContainer.classList.add('hidden'); let errorContent = ""; let filesProcessed = 0; fileCountP.innerHTML = '&nbsp;'; try { const genAI = new GoogleGenerativeAI(state.apiKey); const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" }); updateStatus(`Iniciando transcri√ß√£o... (0/${state.files.length})`); for (const fileData of state.files) { if (state.status === 'stopped') { updateStatus('Processo interrompido.'); break; } while (state.status === 'paused') { await sleep(500); } let transcriptionText = ''; let hasError = false; for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) { try { updateStatus(`Processando: ${fileData.file.name} (Tentativa ${attempt}/${MAX_RETRIES})`); const audioPart = await fileToGenerativePart(fileData.file); const prompt = "Transcreva este √°udio na √≠ntegra. Retorne apenas o texto transcrito."; const result = await model.generateContent([prompt, audioPart]); transcriptionText = result.response.text(); hasError = false; break; } catch (error) { console.warn(`Tentativa ${attempt} falhou para ${fileData.file.name}:`, error); if (error.message && error.message.includes('exceeded your current quota')) { updateStatus('<strong>ERRO DE COTA:</strong> Sua chave de API excedeu a cota de uso. Por favor, troque a chave de API e tente novamente.'); state.status = 'stopped'; hasError = true; break; } if (attempt === MAX_RETRIES) { hasError = true; const errorMessage = error.message ? error.message.replace(/\[.*?\]\s/g, '') : 'Erro desconhecido.'; errorContent += `Arquivo: ${fileData.file.name}\nMotivo: ${errorMessage}\n\n`; } else { await sleep(2000); } } } if (hasError && state.status === 'stopped') break; filesProcessed++; const resultDiv = document.createElement('div'); resultDiv.className = 'result-item'; resultDiv.id = fileData.id; let textHtml; if (hasError) { textHtml = `<div class="result-error"><button class="manual-entry-btn">Adicionar Transcri√ß√£o Manual</button></div>`; } else { textHtml = `<div class="result-text" contenteditable="true">${transcriptionText}</div>`; } resultDiv.innerHTML = ` <div class="result-title"> <span class="result-title-text">${fileData.file.name}</span> <button class="locate-btn" data-filename="${fileData.file.name}" title="Copiar nome do arquivo">&#128193;</button> </div> <audio controls class="audio-player" src="${fileData.url}"></audio> ${textHtml} `; liveReportContainer.appendChild(resultDiv); liveReportContainer.scrollTop = liveReportContainer.scrollHeight; if (errorContent) { errorLogContainer.classList.remove('hidden'); errorLog.value = errorContent; } if (state.status === 'running' && filesProcessed < state.files.length) { await countdown(4, filesProcessed, state.files.length); } } } catch (e) { console.error("Erro na inicializa√ß√£o da API:", e); updateStatus(`<strong>Erro Cr√≠tico:</strong> N√£o foi poss√≠vel conectar √† API. Verifique sua chave.`); state.status = 'stopped'; } if (state.status === 'running') { state.status = 'finished'; updateStatus(`Processo conclu√≠do!`); fileCountP.textContent = `${filesProcessed} de ${state.files.length} arquivos foram processados.`; } else if (state.status === 'stopped') { updateStatus('Processo interrompido.'); fileCountP.textContent = `Interrompido em ${filesProcessed}/${state.files.length} arquivos.` } updateUI(); });
        
        // --- NOVO: L√≥gica para carregar a chave salva ao iniciar a p√°gina ---
        function loadSavedKey() {
            const savedKey = localStorage.getItem('googleApiKey');
            if (savedKey) {
                apiKeyInput.value = savedKey;
                saveApiKeyCheckbox.checked = true;
                apiKeyInput.dispatchEvent(new Event('input')); // Aciona a valida√ß√£o
            }
        }

        // Inicia a aplica√ß√£o
        loadSavedKey();
        updateUI();

    </script>
</body>
</html>
